import 'package:flutter/material.dart';
import 'package:table_calendar/table_calendar.dart';
import '../models/task.dart';
import '../services/api_service.dart';

class CalendarScreen extends StatefulWidget {
  const CalendarScreen({super.key});

  @override
  State<CalendarScreen> createState() => _CalendarScreenState();
}

class _CalendarScreenState extends State<CalendarScreen> {
  final ApiService _apiService = ApiService();
  Map<DateTime, List<Task>> _events = {};
  List<Task> _selectedTasks = [];
  DateTime _focusedDay = DateTime.now();
  DateTime? _selectedDay;
  bool _loading = true;

  @override
  void initState() {
    super.initState();
    _loadTasks();
  }

  /// üîπ T·∫£i to√†n b·ªô c√¥ng vi·ªác t·ª´ API
  Future<void> _loadTasks() async {
    try {
      final response = await _apiService.get("tasks");

      if (response is List) {
        final tasks = response.map((e) => Task.fromJson(e)).toList();

        final map = <DateTime, List<Task>>{};
        for (var t in tasks) {
          if (t.deadline != null && t.deadline!.isNotEmpty) {
            // Parse chu·ªói "2025-11-11" th√†nh DateTime
            final date = DateTime.tryParse(t.deadline!);
            if (date != null) {
              final normalized = DateTime(date.year, date.month, date.day);
              map.putIfAbsent(normalized, () => []).add(t);
            }
          }
        }

        setState(() {
          _events = map;
          _loading = false;
        });
      } else {
        setState(() => _loading = false);
      }
    } catch (e) {
      debugPrint("‚ùå L·ªói t·∫£i task: $e");
      setState(() => _loading = false);
    }
  }

  /// üîπ L·∫•y danh s√°ch c√¥ng vi·ªác trong ng√†y
  List<Task> _getTasksForDay(DateTime day) {
    return _events[DateTime(day.year, day.month, day.day)] ?? [];
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("L·ªãch c√¥ng vi·ªác")),
      body: _loading
          ? const Center(child: CircularProgressIndicator())
          : Column(
              children: [
                TableCalendar<Task>(
                  locale: 'vi_VN',
                  firstDay: DateTime.utc(2020),
                  lastDay: DateTime.utc(2035),
                  focusedDay: _focusedDay,
                  selectedDayPredicate: (day) => isSameDay(_selectedDay, day),
                  onDaySelected: (selectedDay, focusedDay) {
                    setState(() {
                      _selectedDay = selectedDay;
                      _focusedDay = focusedDay;
                      _selectedTasks = _getTasksForDay(selectedDay);
                    });
                  },
                  eventLoader: _getTasksForDay,
                  calendarStyle: const CalendarStyle(
                    todayDecoration: BoxDecoration(
                        color: Colors.purpleAccent, shape: BoxShape.circle),
                    selectedDecoration: BoxDecoration(
                        color: Colors.deepPurple, shape: BoxShape.circle),
                    markerDecoration: BoxDecoration(
                        color: Colors.redAccent, shape: BoxShape.circle),
                  ),
                  headerStyle: const HeaderStyle(
                    formatButtonVisible: false,
                    titleCentered: true,
                  ),
                ),
                const SizedBox(height: 10),
                Expanded(
                  child: _selectedTasks.isEmpty
                      ? const Center(
                          child: Text("Kh√¥ng c√≥ c√¥ng vi·ªác n√†o trong ng√†y n√†y"),
                        )
                      : ListView.builder(
                          itemCount: _selectedTasks.length,
                          itemBuilder: (context, index) {
                            final task = _selectedTasks[index];
                            final dateText = task.deadline != null
                                ? task.deadline!.substring(0, 10)
                                : "Kh√¥ng r√µ";
                            return Card(
                              margin: const EdgeInsets.symmetric(
                                  horizontal: 12, vertical: 6),
                              child: ListTile(
                                title: Text(task.title),
                                subtitle: Text(
                                  "∆Øu ti√™n: ${task.priority ?? 'Kh√¥ng c√≥'}\n"
                                  "Tr·∫°ng th√°i: ${task.status ?? 'Ch∆∞a x√°c ƒë·ªãnh'}\n"
                                  "H·∫°n: $dateText",
                                ),
                                trailing: const Icon(Icons.chevron_right),
                              ),
                            );
                          },
                        ),
                ),
              ],
            ),
    );
  }
}
